#!/usr/bin/env bash

set -Eeuo pipefail

cmd="${1:-bash}"
path="$(tmux display -p '#{pane_current_path}')"
parent_window="$(tmux display -p '#{window_id}')"
if [ "$cmd" = "k9s" ]; then
  # INFO: Kubernetes context is per window
  sanitized_id="$(sed 's/[^a-zA-Z0-9]/%/g' <<<$parent_window)"
else
  sanitized_id="$(sed 's/[^a-zA-Z0-9]/%/g' <<<"$path")"
fi
session="_popup_${cmd}_${sanitized_id}"

if [ "$cmd" = "bash" ]; then
  wrapped_cmd=(bash)
else
  wrapped_cmd=(bash -i -c "${cmd}")
fi

if ! tmux has -t "$session" 2>/dev/null; then
  session_id="$(tmux new-session -dP -s "$session" -F '#{session_id}' -c "$path" -e "POPUPMUX_PARENT_WINDOW=$parent_window" "${wrapped_cmd[*]}")"
  tmux set-option -s -t "$session_id" key-table popup
  tmux set-option -s -t "$session_id" status off
  tmux set-option -s -t "$session_id" prefix None
  # INFO: ANSI escape sequences (OSC 52) does not work in popup
  if uname | grep -q Darwin; then
    tmux bind-key -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
    tmux bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"
  else
    tmux bind-key -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -in -selection clipboard"
    tmux bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "xclip -in -selection clipboard"
  fi
  session="$session_id"
fi

exec tmux attach -t "$session" >/dev/null
