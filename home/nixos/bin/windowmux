#!/usr/bin/env bash

set -euo pipefail

function main() {
  WINDOW_ID="$1"

  IFS=$';' read -r path command title < <(tmux display-message -p -F '#{pane_current_path};#{pane_current_command};#{pane_title}' -t "$WINDOW_ID")

  icon=$(get_app_icon "$command")
  RESULT="$(set-color 12)${icon}$(set-color reset)"

  if [[ "$path" == "$HOME"* ]]; then
    path="${path/$HOME/'~'}"
  fi

  if [ "$command" == "ssh" ]; then
    local _host _path
    _host="${title%%:*}"
    _host="${_host#*@}"
    _path="${title#*:}"
    path="$_path"
    RESULT+=" ${_host}"
  else
    RESULT+=" "
  fi

  IFS='/' read -ra PATH_PARTS <<<"$path"
  if [[ "${#PATH_PARTS[@]}" -gt 1 ]]; then
    RESULT+="$(set-color 8)"
  fi
  for i in "${!PATH_PARTS[@]}"; do
    if [[ -z "${PATH_PARTS[$i]}" ]]; then
      continue
    elif [[ "$i" -eq 0 ]]; then
      RESULT+="${PATH_PARTS[$i]}/"
    elif [[ "$i" -eq $(("${#PATH_PARTS[@]}" - 1)) ]]; then
      RESULT+="$(set-color reset)"
      RESULT+="${PATH_PARTS[$i]}/"
    elif [[ -v NOSHORT ]]; then
      RESULT+="${PATH_PARTS[$i]}/"
    else
      RESULT+="$(shortname "${PATH_PARTS[$i]}")/"
    fi
  done

  echo "$RESULT"
}

function get_app_icon() {
  case "$1" in
  "bash" | "sh")
    echo ""
    ;;
  "k9s")
    echo "󱃾"
    ;;
  "nvim")
    echo ""
    ;;
  "ssh")
    echo "󰍹"
    ;;
  *)
    echo " "
    ;;
  esac
}

main "$@"
